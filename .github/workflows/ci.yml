name: CI

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  code-style:
    name: Code Style Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Check code formatting
      run: |
        # Find all C source files and check formatting
        echo "ğŸ” Checking code formatting with Linux kernel style..."
        
        # Create a temporary file to track issues
        FORMAT_ERRORS=$(mktemp)
        
        # Check each file
        for file in $(find . -name "*.c" -o -name "*.h"); do
          echo "Checking $file..."
          if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
            echo "âŒ $file has formatting issues"
            echo "$file" >> "$FORMAT_ERRORS"
          else
            echo "âœ… $file is properly formatted"
          fi
        done
        
        # Check if we have any errors
        if [ -s "$FORMAT_ERRORS" ]; then
          echo ""
          echo "ğŸš¨ Found formatting issues in the following files:"
          cat "$FORMAT_ERRORS"
          echo ""
          echo "To fix all formatting issues, run:"
          echo "  find . -name '*.c' -o -name '*.h' | xargs clang-format -i"
          echo ""
          echo "Example of formatting issues in $(head -1 "$FORMAT_ERRORS"):"
          clang-format --dry-run --Werror "$(head -1 "$FORMAT_ERRORS")" 2>&1 | head -10 || true
          rm "$FORMAT_ERRORS"
          exit 1
        else
          echo "âœ… All files are properly formatted"
          rm "$FORMAT_ERRORS"
        fi

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86_64, aarch64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc kmod cpio flex bison libssl-dev libelf-dev

    - name: Install cross-compilation tools for ARM64
      if: matrix.arch == 'aarch64'
      run: |
        sudo apt-get install -y gcc-aarch64-linux-gnu

    - name: Download kernel headers
      run: |
        # Use a recent stable kernel version
        KERNEL_VERSION="6.1.0"
        
        # Create a minimal kernel build environment
        mkdir -p kernel-build
        cd kernel-build
        
        # Download kernel source (headers only approach)
        wget -q https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.1.tar.xz
        tar -xf linux-6.1.tar.xz
        cd linux-6.1
        
        # Prepare kernel build
        if [ "${{ matrix.arch }}" = "aarch64" ]; then
          make ARCH=arm64 defconfig
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare
        else
          make defconfig  
          make modules_prepare
        fi

    - name: Build ipcon driver
      run: |
        cd kernel-build/linux-6.1
        
        # Create a simple Makefile for out-of-tree build
        cat > ../../Makefile.build << 'EOF'
        # SPDX-License-Identifier: GPL-2.0
        
        # Kernel build directory
        KERNEL_DIR ?= kernel-build/linux-6.1
        
        # Module name
        MODULE_NAME := ipcon
        
        # Source files - match the original Makefile
        $(MODULE_NAME)-objs := main.o ipcon_nl.o ipcon_msg.o ipcon_db.o name_cache.o
        $(MODULE_NAME)-$(CONFIG_DEBUG_FS) += ipcon_debugfs.o
        
        obj-m := $(MODULE_NAME).o
        
        # Enable CONFIG_IPCON and CONFIG_DEBUG_FS
        EXTRA_CFLAGS += -DCONFIG_IPCON=1 -DCONFIG_DEBUG_FS=1
        
        all:
        	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) modules
        
        clean:
        	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) clean
        EOF
        
        cd ../..
        
        # Build the module
        echo "ğŸ”¨ Building ipcon driver for ${{ matrix.arch }}..."
        if [ "${{ matrix.arch }}" = "aarch64" ]; then
          make -f Makefile.build ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- KERNEL_DIR=kernel-build/linux-6.1 V=1
        else
          make -f Makefile.build KERNEL_DIR=kernel-build/linux-6.1 V=1
        fi
        
        # Check if module was built successfully
        if [ -f ipcon.ko ]; then
          echo "âœ… ipcon.ko built successfully for ${{ matrix.arch }}"
          ls -la ipcon.ko
          file ipcon.ko
          # Check module info
          modinfo ipcon.ko || echo "Could not get module info"
        else
          echo "âŒ Failed to build ipcon.ko for ${{ matrix.arch }}"
          echo "Files in current directory:"
          ls -la
          echo "Looking for any .ko files:"
          find . -name "*.ko" -ls
          exit 1
        fi

    - name: Build verification
      run: |
        echo "Build completed for ${{ matrix.arch }}"
        ls -la *.ko || echo "No .ko files found"